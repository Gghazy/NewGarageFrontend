<div class="container-fluid py-3">

  <!-- Page header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div class="d-flex align-items-center gap-2">
      <h5 class="mb-0 fw-bold">{{ 'INVOICES.FORM.TITLE_DETAILS' | translate }}</h5>
      <span *ngIf="invoice?.invoiceNumber" class="badge bg-primary fs-6">{{ invoice?.invoiceNumber }}</span>
      <span *ngIf="invoice?.type === 'Refund'" class="badge bg-danger fs-6">
        {{ 'INVOICES.FORM.REFUND_INVOICE' | translate }}
      </span>
      <span *ngIf="invoice?.type === 'Adjustment'" class="badge bg-warning text-dark fs-6">
        {{ 'INVOICES.LIST.TYPES.Adjustment' | translate }}
      </span>
      <span *ngIf="invoice?.status" class="badge" [ngClass]="invoice?.status | statusBadge:'invoice'">
        {{ 'INVOICES.LIST.STATUSES.' + invoice?.status | translate }}
      </span>
      <a *ngIf="invoice?.examinationId" class="badge bg-info text-decoration-none"
        [routerLink]="['/features/vehicle-orders', invoice!.examinationId, 'details']">
        <i class="bi bi-link-45deg me-1"></i>{{ 'INVOICES.FORM.LINKED_EXAMINATION' | translate }}
      </a>
    </div>
    <button type="button" class="btn btn-outline-secondary btn-sm" (click)="goBack()">
      <i class="bi bi-arrow-right me-1"></i>{{ 'COMMON.BACK' | translate }}
    </button>
  </div>

  <!-- Loading spinner -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status"></div>
  </div>

  <ng-container *ngIf="!loading && invoice">

    <!-- Client & Branch info -->
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-body">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label text-muted small mb-0">{{ 'INVOICES.FORM.CLIENT' | translate }}</label>
            <div class="fw-semibold">{{ invoice.clientNameAr }}</div>
            <div class="text-muted small">{{ invoice.clientPhone }}</div>
          </div>
          <div class="col-md-3">
            <label class="form-label text-muted small mb-0">{{ 'INVOICES.FORM.BRANCH' | translate }}</label>
            <div class="fw-semibold">{{ invoice.branchNameAr }}</div>
          </div>
          <div class="col-md-3">
            <label class="form-label text-muted small mb-0">{{ 'INVOICES.FORM.DUE_DATE' | translate }}</label>
            <div class="fw-semibold">{{ invoice.dueDate ? (invoice.dueDate | date:'dd/MM/yyyy') : '—' }}</div>
          </div>
        </div>
        <div *ngIf="invoice.notes" class="mt-2">
          <label class="form-label text-muted small mb-0">{{ 'INVOICES.FORM.NOTES' | translate }}</label>
          <div>{{ invoice.notes }}</div>
        </div>
      </div>
    </div>

    <!-- Items table -->
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-header bg-white d-flex justify-content-between align-items-center py-2 section-toggle" (click)="itemsCollapsed = !itemsCollapsed">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-chevron-down toggle-icon" [class.rotated]="itemsCollapsed"></i>
          <h6 class="mb-0 fw-semibold">{{ 'INVOICES.ITEMS.TITLE' | translate }}</h6>
        </div>
      </div>
      <div class="card-body p-0" [hidden]="itemsCollapsed">
        <div class="table-responsive">
          <table class="table table-sm table-bordered mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th style="width:36px">#</th>
                <th>{{ 'INVOICES.ITEMS.DESCRIPTION' | translate }}</th>
                <th style="width:100px">{{ 'INVOICES.ITEMS.QUANTITY' | translate }}</th>
                <th style="width:140px">{{ 'INVOICES.ITEMS.UNIT_PRICE' | translate }}</th>
                <th>{{ 'INVOICES.ITEMS.TOTAL' | translate }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of displayItems; let i = index">
                <td class="text-center text-muted">{{ i + 1 }}</td>
                <td>{{ item.serviceNameAr || item.description }}</td>
                <td class="text-center">{{ item.quantity }}</td>
                <td>{{ item.unitPrice | number:'1.2-2' }} {{ item.currency }}</td>
                <td class="fw-semibold">{{ item.totalPrice | number:'1.2-2' }} {{ item.currency }}</td>
              </tr>
              <tr *ngIf="displayItems.length === 0">
                <td colspan="5" class="text-center text-muted py-3">{{ 'INVOICES.ITEMS.NO_ITEMS' | translate }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Financial Summary -->
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-header bg-white d-flex justify-content-between align-items-center py-2 section-toggle" (click)="summaryCollapsed = !summaryCollapsed">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-chevron-down toggle-icon" [class.rotated]="summaryCollapsed"></i>
          <h6 class="mb-0 fw-semibold">{{ 'INVOICES.SUMMARY.TITLE' | translate }}</h6>
        </div>
      </div>
      <div class="card-body p-0" [hidden]="summaryCollapsed">
        <div class="row g-2 p-3">
          <div class="col-3">
            <div class="border rounded p-2 text-center">
              <small class="text-muted d-block">{{ 'INVOICES.PAYMENTS.SUB_TOTAL' | translate }}</small>
              <strong>{{ invoice.subTotal | number:'1.2-2' }} {{ invoice.currency }}</strong>
            </div>
          </div>
          <div class="col-3">
            <div class="border rounded p-2 text-center">
              <small class="text-muted d-block">{{ 'INVOICES.PAYMENTS.DISCOUNT' | translate }}</small>
              <strong class="text-danger">{{ invoice.discountAmount | number:'1.2-2' }} {{ invoice.currency }}</strong>
            </div>
          </div>
          <div class="col-3">
            <div class="border rounded p-2 text-center">
              <small class="text-muted d-block">{{ 'INVOICES.PAYMENTS.TAX_AMOUNT' | translate }} ({{ invoice.taxRate * 100 | number:'1.0-0' }}%)</small>
              <strong>{{ invoice.taxAmount | number:'1.2-2' }} {{ invoice.currency }}</strong>
            </div>
          </div>
          <div class="col-3">
            <div class="border rounded p-2 text-center bg-light">
              <small class="text-muted d-block">{{ 'INVOICES.PAYMENTS.TOTAL_WITH_TAX' | translate }}</small>
              <strong class="fs-6">{{ invoice.totalWithTax | number:'1.2-2' }} {{ invoice.currency }}</strong>
            </div>
          </div>
          <div *ngIf="refundInvoicesTotal > 0" class="col-3">
            <div class="border rounded p-2 text-center">
              <small class="text-muted d-block">{{ 'INVOICES.SUMMARY.REFUND_TOTAL' | translate }}</small>
              <strong class="text-danger">{{ refundInvoicesTotal | number:'1.2-2' }}- {{ invoice.currency }}</strong>
            </div>
          </div>
          <div *ngIf="refundInvoicesTotal > 0" class="col-3">
            <div class="border rounded p-2 text-center bg-light">
              <small class="text-muted d-block">{{ 'INVOICES.SUMMARY.NET_TOTAL' | translate }}</small>
              <strong class="fs-6">{{ netTotalWithTax | number:'1.2-2' }} {{ invoice.currency }}</strong>
            </div>
          </div>
          <div class="col-4">
            <div class="border rounded p-2 text-center">
              <small class="text-muted d-block">{{ 'INVOICES.PAYMENTS.TOTAL_PAID' | translate }}</small>
              <strong class="text-success">{{ invoice.totalPaid | number:'1.2-2' }} {{ invoice.currency }}</strong>
            </div>
          </div>
          <div class="col-4">
            <div class="border rounded p-2 text-center">
              <small class="text-muted d-block">{{ 'INVOICES.PAYMENTS.TOTAL_REFUNDED' | translate }}</small>
              <strong class="text-danger">{{ invoice.totalRefunded | number:'1.2-2' }} {{ invoice.currency }}</strong>
            </div>
          </div>
          <div class="col-4">
            <div class="border rounded p-2 text-center">
              <small class="text-muted d-block">{{ 'INVOICES.PAYMENTS.BALANCE' | translate }}</small>
              <strong [class.text-danger]="netBalance > 0" [class.text-success]="netBalance <= 0">{{ netBalance | number:'1.2-2' }} {{ invoice.currency }}</strong>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Discount section (Issued only, not for Refund) -->
    <app-invoice-discount-section
      *ngIf="invoice.status === 'Issued' && invoice.type !== 'Refund'"
      [invoice]="invoice"
      (discountSaved)="loadInvoice()">
    </app-invoice-discount-section>

    <!-- Related Invoices (Refund / Adjustment) -->
    <div *ngIf="invoice.relatedInvoices && invoice.relatedInvoices.length > 0" class="card border-0 shadow-sm mb-3">
      <div class="card-header bg-white d-flex justify-content-between align-items-center py-2 section-toggle" (click)="relatedCollapsed = !relatedCollapsed">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-chevron-down toggle-icon" [class.rotated]="relatedCollapsed"></i>
          <h6 class="mb-0 fw-semibold">{{ 'INVOICES.RELATED.TITLE' | translate }}</h6>
        </div>
      </div>
      <div class="card-body p-0" [hidden]="relatedCollapsed">
        <div class="table-responsive">
          <table class="table table-sm table-bordered mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th style="width:36px">#</th>
                <th>{{ 'INVOICES.LIST.INVOICE_NUMBER' | translate }}</th>
                <th>{{ 'INVOICES.LIST.TYPE' | translate }}</th>
                <th>{{ 'INVOICES.LIST.STATUS' | translate }}</th>
                <th>{{ 'INVOICES.LIST.TOTAL' | translate }}</th>
                <th>{{ 'INVOICES.LIST.DATE' | translate }}</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let rel of invoice.relatedInvoices; let i = index"
                  [class.table-active]="rel.id === invoice.id">
                <td class="text-center text-muted">{{ i + 1 }}</td>
                <td>{{ rel.invoiceNumber || '—' }}</td>
                <td>
                  <span class="badge"
                    [class.bg-primary]="rel.type === 'Invoice'"
                    [class.bg-danger]="rel.type === 'Refund'"
                    [class.bg-warning]="rel.type === 'Adjustment'"
                    [class.text-dark]="rel.type === 'Adjustment'">
                    {{ 'INVOICES.LIST.TYPES.' + rel.type | translate }}
                  </span>
                </td>
                <td>
                  <span class="badge" [ngClass]="rel.status | statusBadge:'invoice'">
                    {{ 'INVOICES.LIST.STATUSES.' + rel.status | translate }}
                  </span>
                </td>
                <td class="fw-semibold">{{ rel.totalWithTax | number:'1.2-2' }} {{ rel.currency }}</td>
                <td>{{ rel.createdAtUtc | date:'dd/MM/yyyy' }}</td>
                <td class="text-center">
                  <a class="btn btn-sm btn-outline-primary" [routerLink]="['/features/invoices', rel.id, 'view']">
                    <i class="bi bi-eye"></i>
                  </a>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- History -->
    <div class="card border-0 shadow-sm mb-3">
      <div class="card-header bg-white d-flex justify-content-between align-items-center py-2 section-toggle" (click)="historyCollapsed = !historyCollapsed">
        <div class="d-flex align-items-center gap-2">
          <i class="bi bi-chevron-down toggle-icon" [class.rotated]="historyCollapsed"></i>
          <h6 class="mb-0 fw-semibold">{{ 'INVOICES.HISTORY.TITLE' | translate }}</h6>
        </div>
      </div>
      <div class="card-body p-0" [hidden]="historyCollapsed">
        <div *ngIf="historyLoading" class="history-loading">
          <div class="spinner-border spinner-border-sm" role="status"></div>
        </div>
        <div *ngIf="!historyLoading && historyItems.length === 0" class="history-empty">
          <i class="bi bi-clock"></i>
          {{ 'INVOICES.HISTORY.NO_HISTORY' | translate }}
        </div>
        <div *ngIf="!historyLoading && historyItems.length > 0" class="history-timeline">
          <div class="history-item" *ngFor="let h of historyItems">
            <div class="history-icon" [style.background]="getActionColor(h.action) + '18'" [style.color]="getActionColor(h.action)">
              <i class="bi" [ngClass]="getActionIcon(h.action)"></i>
            </div>
            <div class="history-content">
              <div class="history-action">{{ 'INVOICES.HISTORY.ACTIONS.' + h.action | translate }}</div>
              <div *ngIf="h.details" class="history-details">{{ h.details }}</div>
              <div class="history-meta">
                <span *ngIf="getPerformerName(h)" class="history-user">
                  <i class="bi bi-person-fill"></i>{{ getPerformerName(h) }}
                </span>
                <span class="history-time">
                  <i class="bi bi-clock"></i>{{ h.createdAtUtc | date:'dd/MM/yyyy hh:mm a' }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </ng-container>

</div>
