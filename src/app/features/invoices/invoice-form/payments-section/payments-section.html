<div class="card border-0 shadow-sm mb-3">
  <div class="card-header bg-white d-flex justify-content-between align-items-center py-2 section-toggle" (click)="collapsed = !collapsed">
    <div class="d-flex align-items-center gap-2">
      <i class="bi bi-chevron-down toggle-icon" [class.rotated]="collapsed"></i>
      <h6 class="mb-0 fw-semibold">{{ 'INVOICES.PAYMENTS.TITLE' | translate }}</h6>
    </div>
    <div *ngIf="invoice?.status === 'Issued' && invoice?.type !== 'Refund'" class="d-flex gap-1" (click)="$event.stopPropagation()">
      <button type="button" class="btn btn-sm btn-success" (click)="openForm('Payment')">
        <i class="bi bi-plus-lg me-1"></i>{{ 'INVOICES.PAYMENTS.ADD_PAYMENT' | translate }}
      </button>
      <button type="button" class="btn btn-sm btn-outline-danger" (click)="openForm('Refund')">
        <i class="bi bi-arrow-return-left me-1"></i>{{ 'INVOICES.PAYMENTS.ADD_REFUND' | translate }}
      </button>
    </div>
  </div>

  <div class="card-body p-0" [hidden]="collapsed">

    <!-- Summary cards -->
    <div class="row g-2 p-3">
      <div class="col-4">
        <div class="border rounded p-2 text-center">
          <small class="text-muted d-block">{{ 'INVOICES.PAYMENTS.SUB_TOTAL' | translate }}</small>
          <strong>{{ subTotal | number:'1.2-2' }}</strong>
        </div>
      </div>
      <div class="col-4">
        <div class="border rounded p-2 text-center">
          <small class="text-muted d-block">{{ 'INVOICES.PAYMENTS.DISCOUNT' | translate }}</small>
          <strong class="text-danger">{{ discountAmount | number:'1.2-2' }}</strong>
        </div>
      </div>
      <div class="col-4">
        <div class="border rounded p-2 text-center">
          <small class="text-muted d-block">{{ 'INVOICES.PAYMENTS.TAX_AMOUNT' | translate }} ({{ taxRate * 100 | number:'1.0-0' }}%)</small>
          <strong>{{ taxAmount | number:'1.2-2' }}</strong>
        </div>
      </div>
      <div class="col-4">
        <div class="border rounded p-2 text-center bg-light">
          <small class="text-muted d-block">{{ 'INVOICES.PAYMENTS.TOTAL_WITH_TAX' | translate }}</small>
          <strong class="fs-6">{{ totalWithTax | number:'1.2-2' }}</strong>
        </div>
      </div>
      <div class="col-4">
        <div class="border rounded p-2 text-center">
          <small class="text-muted d-block">{{ 'INVOICES.PAYMENTS.TOTAL_PAID' | translate }}</small>
          <strong class="text-success">{{ totalPaid | number:'1.2-2' }}</strong>
        </div>
      </div>
      <div class="col-4">
        <div class="border rounded p-2 text-center">
          <small class="text-muted d-block">{{ 'INVOICES.PAYMENTS.TOTAL_REFUNDED' | translate }}</small>
          <strong class="text-danger">{{ totalRefunded | number:'1.2-2' }}</strong>
        </div>
      </div>
      <div class="col-4">
        <div class="border rounded p-2 text-center">
          <small class="text-muted d-block">{{ 'INVOICES.PAYMENTS.BALANCE' | translate }}</small>
          <strong [class.text-danger]="balance > 0" [class.text-success]="balance <= 0">{{ balance | number:'1.2-2' }}</strong>
        </div>
      </div>
    </div>

    <!-- Add Payment/Refund form -->
    <div *ngIf="showForm" class="border-top p-3 bg-light">
      <h6 class="fw-semibold mb-2">
        {{ (formMode === 'Refund' ? 'INVOICES.PAYMENTS.ADD_REFUND' : 'INVOICES.PAYMENTS.ADD_PAYMENT') | translate }}
      </h6>
      <div [formGroup]="form" class="row g-2 align-items-end">
        <div class="col-md-3">
          <label class="form-label small">{{ 'INVOICES.PAYMENTS.AMOUNT' | translate }}</label>
          <input type="number" class="form-control form-control-sm" formControlName="amount" min="0.01" step="0.01" />
        </div>
        <div class="col-md-3">
          <label class="form-label small">{{ 'INVOICES.PAYMENTS.METHOD' | translate }}</label>
          <select class="form-select form-select-sm" formControlName="method">
            <option *ngFor="let m of paymentMethods" [value]="m">
              {{ 'INVOICES.PAYMENTS.METHODS.' + m | translate }}
            </option>
          </select>
        </div>
        <div class="col-md-3">
          <label class="form-label small">{{ 'INVOICES.PAYMENTS.NOTES' | translate }}</label>
          <input type="text" class="form-control form-control-sm" formControlName="notes" />
        </div>
        <div class="col-md-3 d-flex gap-1">
          <button type="button" class="btn btn-sm" [class.btn-primary]="formMode === 'Payment'" [class.btn-danger]="formMode === 'Refund'" (click)="submit()" [disabled]="form.invalid || saving">
            <span *ngIf="saving" class="spinner-border spinner-border-sm me-1"></span>
            {{ 'COMMON.SAVE' | translate }}
          </button>
          <button type="button" class="btn btn-sm btn-outline-secondary" (click)="cancelForm()">
            {{ 'COMMON.CANCEL' | translate }}
          </button>
        </div>
      </div>
    </div>

    <!-- Payments table -->
    <div class="table-responsive">
      <table class="table table-sm table-bordered mb-0 align-middle">
        <thead class="table-light">
          <tr>
            <th style="width:36px">#</th>
            <th>{{ 'INVOICES.PAYMENTS.DATE' | translate }}</th>
            <th>{{ 'INVOICES.PAYMENTS.TYPE' | translate }}</th>
            <th>{{ 'INVOICES.PAYMENTS.AMOUNT' | translate }}</th>
            <th>{{ 'INVOICES.PAYMENTS.METHOD' | translate }}</th>
            <th>{{ 'INVOICES.PAYMENTS.NOTES' | translate }}</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of payments; let i = index">
            <td class="text-center text-muted">{{ i + 1 }}</td>
            <td>{{ p.createdAtUtc | date:'yyyy-MM-dd HH:mm' }}</td>
            <td>
              <span class="badge" [class.bg-success]="p.type === 'Payment'" [class.bg-danger]="p.type === 'Refund'">
                {{ 'INVOICES.PAYMENTS.TYPES.' + p.type | translate }}
              </span>
            </td>
            <td class="fw-semibold">{{ p.amount | number:'1.2-2' }} {{ p.currency }}</td>
            <td>{{ 'INVOICES.PAYMENTS.METHODS.' + p.method | translate }}</td>
            <td class="text-muted">{{ p.notes || 'â€”' }}</td>
          </tr>

          <tr *ngIf="payments.length === 0">
            <td colspan="6" class="text-center text-muted py-3">
              {{ 'INVOICES.PAYMENTS.NO_PAYMENTS' | translate }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
