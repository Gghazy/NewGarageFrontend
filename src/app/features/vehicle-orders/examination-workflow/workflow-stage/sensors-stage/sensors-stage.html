<div *ngIf="loading" class="text-center py-4">
  <div class="spinner-border spinner-border-sm text-primary"></div>
</div>

<ng-container *ngIf="!loading">

  <div class="row g-4">

    <!-- RIGHT SIDE: Form -->
    <div class="col-lg-6">

      <!-- No issues checkbox -->
      <div class="form-check mb-3">
        <input type="checkbox" class="form-check-input" id="noIssues"
               [(ngModel)]="noIssuesFound" (change)="toggleNoIssues()">
        <label class="form-check-label fw-semibold" for="noIssues">
          {{ 'WORKFLOW.NO_ISSUES_FOUND' | translate }}
        </label>
      </div>

      <!-- Cylinder count + Issue code -->
      <div [class.disabled-section]="noIssuesFound">
        <div class="mb-3">
          <label class="form-label">{{ 'WORKFLOW.CYLINDER_COUNT' | translate }}</label>
          <input type="number" class="form-control" min="1" max="16"
                 [(ngModel)]="cylinderCount" [disabled]="noIssuesFound">
        </div>
        <div class="mb-3">
          <label class="form-label">{{ 'WORKFLOW.ISSUE_CODE' | translate }}</label>
          <ng-select [items]="availableIssues"
                     [bindLabel]="isAr ? 'nameAr' : 'nameEn'"
                     bindValue="id"
                     [(ngModel)]="selectedIssueId"
                     [placeholder]="'WORKFLOW.SELECT_ISSUE' | translate"
                     [disabled]="noIssuesFound"
                     [clearable]="true"
                     [searchable]="true">
            <ng-template ng-option-tmp let-item="item">
              <span class="fw-semibold me-2">{{ item.code }}</span>
              <span>{{ isAr ? item.nameAr : item.nameEn }}</span>
            </ng-template>
          </ng-select>
        </div>
        <button class="btn btn-primary"
                [disabled]="noIssuesFound || !selectedIssueId"
                (click)="addIssue()">
          <i class="bi bi-plus-lg me-1"></i>
          {{ 'WORKFLOW.ADD' | translate }}
        </button>
      </div>

      <!-- Technical terms explanation -->
      <div class="terms-card mt-4">
        <div class="terms-header">
          <i class="bi bi-info-circle"></i>
          {{ 'WORKFLOW.TECHNICAL_TERMS' | translate }}
        </div>
        <div class="terms-body">
          <div class="term-item">
            <span class="term-label">{{ 'WORKFLOW.ACTIVE' | translate }}:</span>
            <span class="term-desc">{{ 'WORKFLOW.ACTIVE_DESC' | translate }}</span>
          </div>
          <div class="term-item">
            <span class="term-label">{{ 'WORKFLOW.STORED' | translate }}:</span>
            <span class="term-desc">{{ 'WORKFLOW.STORED_DESC' | translate }}</span>
          </div>
        </div>
      </div>

      <!-- Comments -->
      <div class="mt-4 mb-3">
        <label class="form-label">{{ 'WORKFLOW.COMMENTS' | translate }}</label>
        <textarea class="form-control" rows="3"
                  [(ngModel)]="comments"
                  [placeholder]="'WORKFLOW.COMMENTS_PLACEHOLDER' | translate"></textarea>
      </div>

      <!-- Save button -->
      <div class="d-flex justify-content-end">
        <button class="btn btn-success px-4" (click)="save()" [disabled]="saving">
          <span *ngIf="saving" class="spinner-border spinner-border-sm me-1"></span>
          <i *ngIf="!saving" class="bi bi-check-lg me-1"></i>
          {{ 'COMMON.SAVE' | translate }}
        </button>
      </div>

    </div>

    <!-- LEFT SIDE: Table -->
    <div class="col-lg-6">
      <div *ngIf="addedIssues.length > 0" class="table-responsive">
        <table class="table table-bordered table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th>{{ 'WORKFLOW.ISSUE_CODE' | translate }}</th>
              <th>{{ 'WORKFLOW.DESCRIPTION' | translate }}</th>
              <th class="text-center" colspan="2">{{ 'WORKFLOW.EVALUATION' | translate }}</th>
              <th class="text-center" style="width: 60px;">{{ 'WORKFLOW.ACTION' | translate }}</th>
            </tr>
            <tr>
              <th></th>
              <th></th>
              <th class="text-center eval-header">{{ 'WORKFLOW.ACTIVE' | translate }}</th>
              <th class="text-center eval-header">{{ 'WORKFLOW.STORED' | translate }}</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of addedIssues; let i = index">
              <td class="fw-semibold">{{ row.code }}</td>
              <td>{{ isAr ? row.nameAr : row.nameEn }}</td>
              <td class="text-center">
                <input type="radio" class="form-check-input"
                       [name]="'eval_' + i" value="active"
                       [(ngModel)]="row.evaluation">
              </td>
              <td class="text-center">
                <input type="radio" class="form-check-input"
                       [name]="'eval_' + i" value="stored"
                       [(ngModel)]="row.evaluation">
              </td>
              <td class="text-center">
                <button class="btn btn-sm btn-outline-danger" (click)="removeIssue(i)">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div *ngIf="addedIssues.length === 0 && !noIssuesFound" class="empty-state-sm">
        <i class="bi bi-clipboard-plus text-muted"></i>
        <small>{{ 'WORKFLOW.ADD_ISSUES_HINT' | translate }}</small>
      </div>
    </div>

  </div>

</ng-container>
