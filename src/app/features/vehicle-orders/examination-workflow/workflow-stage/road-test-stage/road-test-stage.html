<div *ngIf="loading" class="text-center py-4">
  <div class="spinner-border spinner-border-sm text-primary"></div>
</div>

<ng-container *ngIf="!loading">

  <div class="row g-4">

    <!-- Form side -->
    <div class="col-lg-5">

      <!-- No issues checkbox -->
      <div class="form-check mb-3">
        <input type="checkbox" class="form-check-input" id="noRoadTestIssues"
               [(ngModel)]="noIssuesFound" (change)="toggleNoIssues()" [disabled]="readOnly">
        <label class="form-check-label fw-semibold" for="noRoadTestIssues">
          {{ 'WORKFLOW.NO_ISSUES_FOUND' | translate }}
        </label>
      </div>

      <!-- Issue type + Issue selection -->
      <div [class.disabled-section]="noIssuesFound" *ngIf="!readOnly">
        <div class="mb-3">
          <label class="form-label">{{ 'WORKFLOW.ROAD_TEST_PART' | translate }}</label>
          <ng-select [items]="issueTypes"
                     [bindLabel]="isAr ? 'nameAr' : 'nameEn'"
                     bindValue="id"
                     [(ngModel)]="selectedIssueTypeId"
                     (change)="onIssueTypeChange()"
                     [placeholder]="'WORKFLOW.SELECT_ROAD_TEST_PART' | translate"
                     [disabled]="noIssuesFound"
                     [clearable]="true"
                     [searchable]="true">
          </ng-select>
        </div>

        <div class="mb-3">
          <label class="form-label">{{ 'WORKFLOW.ROAD_TEST_ISSUES' | translate }}</label>
          <ng-select [items]="filteredIssues"
                     [bindLabel]="isAr ? 'nameAr' : 'nameEn'"
                     bindValue="id"
                     [(ngModel)]="selectedIssueId"
                     [placeholder]="'WORKFLOW.SELECT_ROAD_TEST_ISSUE' | translate"
                     [disabled]="noIssuesFound || !selectedIssueTypeId"
                     [clearable]="true"
                     [searchable]="true">
          </ng-select>
        </div>

        <button class="btn btn-primary"
                [disabled]="noIssuesFound || !selectedIssueId"
                (click)="addRow()">
          <i class="bi bi-plus-lg me-1"></i>
          {{ 'WORKFLOW.ADD' | translate }}
        </button>
      </div>

      <!-- Comments -->
      <div class="mt-4 mb-3">
        <label class="form-label">{{ 'WORKFLOW.COMMENTS' | translate }}</label>
        <textarea class="form-control" rows="3"
                  [(ngModel)]="comments"
                  [placeholder]="'WORKFLOW.COMMENTS_PLACEHOLDER' | translate"
                  [disabled]="readOnly"></textarea>
      </div>

      <!-- Save button -->
      <div *ngIf="!readOnly" class="d-flex justify-content-end">
        <button class="btn btn-success px-4" (click)="save()" [disabled]="saving">
          <span *ngIf="saving" class="spinner-border spinner-border-sm me-1"></span>
          <i *ngIf="!saving" class="bi bi-check-lg me-1"></i>
          {{ 'COMMON.SAVE' | translate }}
        </button>
      </div>

    </div>

    <!-- Table side -->
    <div class="col-lg-7">
      <div *ngIf="rows.length > 0" class="table-responsive">
        <table class="table table-bordered table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th style="width: 50px;">#</th>
              <th>{{ 'WORKFLOW.ROAD_TEST_PART' | translate }}</th>
              <th>{{ 'WORKFLOW.ROAD_TEST_ISSUES' | translate }}</th>
              <th *ngIf="!readOnly" class="text-center" style="width: 60px;">{{ 'WORKFLOW.ACTION' | translate }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let row of rows; let i = index">
              <td class="fw-semibold">{{ i + 1 }}</td>
              <td>{{ getIssueTypeName(row.issueTypeId) }}</td>
              <td>{{ getIssueName(row.issueId) }}</td>
              <td *ngIf="!readOnly" class="text-center">
                <button class="btn btn-sm btn-outline-danger" (click)="removeRow(i)">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div *ngIf="rows.length === 0 && !noIssuesFound" class="empty-state-sm">
        <i class="bi bi-clipboard-plus text-muted"></i>
        <small>{{ 'WORKFLOW.ADD_ROAD_TEST_HINT' | translate }}</small>
      </div>
    </div>

  </div>

</ng-container>
