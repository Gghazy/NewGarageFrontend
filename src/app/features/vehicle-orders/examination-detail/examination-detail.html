<div class="container-fluid py-3">

  <ng-container *ngIf="!isWorkflowActive">

  <!-- Page Header -->
  <div class="detail-header d-flex justify-content-between align-items-center flex-wrap gap-2">
    <div class="d-flex align-items-center gap-3">
      <h5 class="detail-title">{{ 'VEHICLE_ORDERS.DETAIL.TITLE' | translate }}</h5>
      <div class="header-badges">
        <span *ngIf="examination?.status" class="badge status-pill" [ngClass]="examination?.status | statusBadge:'examination'">
          {{ 'VEHICLE_ORDERS.LIST.STATUSES.' + examination?.status | translate }}
        </span>
        <span *ngIf="examination?.type" class="type-pill">
          {{ 'VEHICLE_ORDERS.VEHICLE.TYPE_' + examination?.type | uppercase | translate }}
        </span>
      </div>
    </div>
    <div class="header-actions">
      <!-- Start -->
      <button *ngIf="canStart && authService.hasPermission('examination.start')"
        type="button" class="btn btn-success" (click)="start()" [disabled]="actionLoading">
        <i class="bi bi-play-fill"></i>{{ 'VEHICLE_ORDERS.DETAIL.START' | translate }}
      </button>
      <!-- Open Workflow -->
      <button *ngIf="canOpenWorkflow && (authService.hasPermission('examination.update') || authService.hasPermission('examination.read'))"
        type="button" class="btn btn-primary" (click)="openWorkflow()" [disabled]="actionLoading">
        <i class="bi bi-diagram-3"></i>{{ 'VEHICLE_ORDERS.DETAIL.OPEN_WORKFLOW' | translate }}
      </button>
      <!-- Complete -->
      <button *ngIf="canComplete && authService.hasPermission('examination.update')"
        type="button" class="btn btn-success" (click)="complete()" [disabled]="actionLoading">
        <i class="bi bi-check-circle"></i>{{ 'VEHICLE_ORDERS.DETAIL.COMPLETE' | translate }}
      </button>
      <!-- Deliver -->
      <button *ngIf="canDeliver && authService.hasPermission('examination.deliver')"
        type="button" class="btn btn-info text-white" (click)="deliver()" [disabled]="actionLoading">
        <i class="bi bi-truck"></i>{{ 'VEHICLE_ORDERS.DETAIL.DELIVER' | translate }}
      </button>
      <!-- Generate Report -->
      <button *ngIf="canGenerateReport && authService.hasPermission('examination.report')"
        type="button" class="btn btn-outline-info" (click)="generateReport()" [disabled]="actionLoading">
        <i class="bi bi-file-earmark-text"></i>{{ 'VEHICLE_ORDERS.DETAIL.GENERATE_REPORT' | translate }}
      </button>
      <!-- Edit -->
      <button *ngIf="canEdit && authService.hasPermission('examination.update')"
        type="button" class="btn btn-outline-primary" (click)="openEdit()">
        <i class="bi bi-pencil"></i>{{ 'COMMON.EDIT' | translate }}
      </button>
      <!-- Reopen -->
      <button *ngIf="canReopen && authService.hasPermission('examination.reopen')"
        type="button" class="btn btn-outline-warning" (click)="reopen()" [disabled]="actionLoading">
        <i class="bi bi-arrow-counterclockwise"></i>{{ 'VEHICLE_ORDERS.DETAIL.REOPEN' | translate }}
      </button>
      <!-- Cancel -->
      <button *ngIf="canCancel && authService.hasPermission('examination.cancel')"
        type="button" class="btn btn-outline-danger" (click)="cancel()" [disabled]="actionLoading">
        <i class="bi bi-x-circle"></i>{{ 'VEHICLE_ORDERS.DETAIL.CANCEL' | translate }}
      </button>
      <!-- Back -->
      <button type="button" class="btn btn-outline-secondary" (click)="goBack()">
        <i class="bi bi-arrow-right"></i>{{ 'COMMON.BACK' | translate }}
      </button>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="detail-loading">
    <div class="spinner-border" role="status"></div>
  </div>

  <ng-container *ngIf="!loading && examination">

    <!-- Summary Cards -->
    <div class="summary-row">
      <div class="summary-card card-client">
        <div class="summary-icon client">
          <i class="bi bi-person-fill"></i>
        </div>
        <div class="summary-info">
          <div class="summary-label">{{ 'VEHICLE_ORDERS.LIST.CLIENT' | translate }}</div>
          <div class="summary-value">{{ isAr ? examination.clientNameAr : (examination.clientNameEn || examination.clientNameAr) }}</div>
          <div *ngIf="examination.clientPhone" class="summary-sub">{{ examination.clientPhone }}</div>
        </div>
      </div>

      <div class="summary-card card-vehicle">
        <div class="summary-icon vehicle">
          <i class="bi bi-car-front-fill"></i>
        </div>
        <div class="summary-info">
          <div class="summary-label">{{ 'VEHICLE_ORDERS.VEHICLE.CAR_MARK' | translate }}</div>
          <div class="summary-value">{{ (isAr ? examination.manufacturerNameAr : (examination.manufacturerNameEn || examination.manufacturerNameAr)) + ' - ' + (isAr ? examination.carMarkNameAr : (examination.carMarkNameEn || examination.carMarkNameAr)) }}</div>
        </div>
      </div>

      <div class="summary-card card-plate">
        <div class="summary-icon plate">
          <i class="bi bi-credit-card-2-front-fill"></i>
        </div>
        <div class="summary-info">
          <div class="summary-label">{{ 'VEHICLE_ORDERS.VEHICLE.PLATE_LETTERS' | translate }}</div>
          <div class="summary-value">{{ getPlateDisplay() }}</div>
        </div>
      </div>

      <div class="summary-card card-mileage">
        <div class="summary-icon mileage">
          <i class="bi bi-speedometer2"></i>
        </div>
        <div class="summary-info">
          <div class="summary-label">{{ 'VEHICLE_ORDERS.VEHICLE.MILEAGE' | translate }}</div>
          <div class="summary-value">{{ examination.mileage != null ? (examination.mileage | number) + ' ' + examination.mileageUnit : '—' }}</div>
        </div>
      </div>

      <div class="summary-card card-branch">
        <div class="summary-icon branch">
          <i class="bi bi-building"></i>
        </div>
        <div class="summary-info">
          <div class="summary-label">{{ 'VEHICLE_ORDERS.VEHICLE.BRANCH' | translate }}</div>
          <div class="summary-value">{{ isAr ? examination.branchNameAr : (examination.branchNameEn || examination.branchNameAr) }}</div>
        </div>
      </div>

      <div class="summary-card card-date">
        <div class="summary-icon date">
          <i class="bi bi-calendar3"></i>
        </div>
        <div class="summary-info">
          <div class="summary-label">{{ 'VEHICLE_ORDERS.LIST.DATE' | translate }}</div>
          <div class="summary-value">{{ examination.createdAtUtc ? (examination.createdAtUtc | date:'yyyy-MM-dd') : '—' }}</div>
        </div>
      </div>
    </div>

    <!-- Vehicle Details -->
    <div class="detail-card">
      <div class="detail-card-header" (click)="vehicleCollapsed = !vehicleCollapsed">
        <i class="bi bi-car-front"></i>
        <h6>{{ 'VEHICLE_ORDERS.DETAIL.VEHICLE_INFO' | translate }}</h6>
        <i class="bi bi-chevron-down toggle-icon ms-auto" [class.rotated]="vehicleCollapsed"></i>
      </div>
      <div class="detail-card-body" [hidden]="vehicleCollapsed">
        <div class="info-grid">
          <div class="info-item">
            <span class="info-label">{{ 'VEHICLE_ORDERS.VEHICLE.TYPE' | translate }}</span>
            <span class="info-value" [class.empty]="!examination.type">{{ examination.type || '—' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">{{ 'VEHICLE_ORDERS.VEHICLE.YEAR' | translate }}</span>
            <span class="info-value" [class.empty]="!examination.year">{{ examination.year || '—' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">{{ 'VEHICLE_ORDERS.VEHICLE.COLOR' | translate }}</span>
            <span class="info-value" [class.empty]="!examination.color">{{ examination.color || '—' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">{{ 'VEHICLE_ORDERS.VEHICLE.TRANSMISSION' | translate }}</span>
            <span class="info-value" [class.empty]="!examination.transmission">{{ examination.transmission || '—' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">{{ 'VEHICLE_ORDERS.VEHICLE.VIN' | translate }}</span>
            <span class="info-value" [class.empty]="!examination.vin">{{ examination.vin || '—' }}</span>
          </div>
          <div class="info-item">
            <span class="info-label">{{ 'VEHICLE_ORDERS.VEHICLE.WARRANTY' | translate }}</span>
            <span class="info-value">{{ (examination.hasWarranty ? 'VEHICLE_ORDERS.VEHICLE.WITH_WARRANTY' : 'VEHICLE_ORDERS.VEHICLE.NO_WARRANTY') | translate }}</span>
          </div>
          <div *ngIf="examination.notes" class="info-item info-full">
            <span class="info-label">{{ 'VEHICLE_ORDERS.VEHICLE.NOTES' | translate }}</span>
            <div class="notes-box">{{ examination.notes }}</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Services -->
    <div class="detail-card">
      <div class="detail-card-header" (click)="servicesCollapsed = !servicesCollapsed">
        <i class="bi bi-tools"></i>
        <h6>{{ 'VEHICLE_ORDERS.DETAIL.SERVICES' | translate }}</h6>
        <i class="bi bi-chevron-down toggle-icon ms-auto" [class.rotated]="servicesCollapsed"></i>
      </div>
      <div [hidden]="servicesCollapsed">
        <div class="table-responsive">
          <table class="detail-table">
            <thead>
              <tr>
                <th class="row-num">#</th>
                <th>{{ 'VEHICLE_ORDERS.SERVICES.SERVICE' | translate }}</th>
                <th style="width:100px" class="text-center">{{ 'VEHICLE_ORDERS.SERVICES.QUANTITY' | translate }}</th>
                <th style="width:140px" class="text-center">{{ 'VEHICLE_ORDERS.SERVICES.OVERRIDE_PRICE' | translate }}</th>
                <th style="width:120px">{{ 'VEHICLE_ORDERS.LIST.STATUS' | translate }}</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of examination.items; let i = index">
                <td class="row-num">{{ i + 1 }}</td>
                <td class="fw-semibold">{{ isAr ? item.serviceNameAr : (item.serviceNameEn || item.serviceNameAr) }}</td>
                <td class="text-center">{{ item.quantity }}</td>
                <td class="text-center">{{ item.overridePrice != null ? (item.overridePrice | number:'1.2-2') : '—' }}</td>
                <td>
                  <span class="badge" [ngClass]="item.status | statusBadge:'examinationItem'">
                    {{ item.status || '—' }}
                  </span>
                </td>
              </tr>
              <tr *ngIf="examination.items.length === 0" class="empty-row">
                <td colspan="5">
                  <i class="bi bi-inbox"></i>
                  {{ 'VEHICLE_ORDERS.DETAIL.NO_SERVICES' | translate }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Invoices -->
    <div class="detail-card">
      <div class="detail-card-header" (click)="invoicesCollapsed = !invoicesCollapsed">
        <i class="bi bi-receipt-cutoff"></i>
        <h6>{{ 'VEHICLE_ORDERS.DETAIL.INVOICES' | translate }}</h6>
        <i class="bi bi-chevron-down toggle-icon ms-auto" [class.rotated]="invoicesCollapsed"></i>
      </div>
      <div [hidden]="invoicesCollapsed">
        <div *ngIf="invoicesLoading" class="detail-loading" style="padding: 30px 20px;">
          <div class="spinner-border spinner-border-sm" role="status"></div>
        </div>
        <div class="table-responsive" *ngIf="!invoicesLoading">
          <table class="detail-table">
            <thead>
              <tr>
                <th class="row-num">#</th>
                <th>{{ 'INVOICES.LIST.INVOICE_NUMBER' | translate }}</th>
                <th>{{ 'INVOICES.LIST.TYPE' | translate }}</th>
                <th>{{ 'INVOICES.LIST.STATUS' | translate }}</th>
                <th>{{ 'INVOICES.LIST.TOTAL' | translate }}</th>
                <th>{{ 'INVOICES.LIST.DATE' | translate }}</th>
                <th style="width:50px"></th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let inv of invoices; let i = index">
                <td class="row-num">{{ i + 1 }}</td>
                <td class="fw-semibold">{{ inv.invoiceNumber || '—' }}</td>
                <td>
                  <span class="badge" [ngClass]="inv.type | statusBadge:'invoiceType'">
                    {{ 'INVOICES.LIST.TYPES.' + inv.type | translate }}
                  </span>
                </td>
                <td>
                  <span class="badge" [ngClass]="inv.status | statusBadge:'invoice'">
                    {{ 'INVOICES.LIST.STATUSES.' + inv.status | translate }}
                  </span>
                </td>
                <td class="fw-semibold">{{ inv.totalWithTax | number:'1.2-2' }} {{ inv.currency }}</td>
                <td>{{ inv.createdAtUtc | date:'yyyy-MM-dd' }}</td>
                <td class="text-center">
                  <button class="btn-view" [routerLink]="['/features/invoices', inv.id]">
                    <i class="bi bi-eye"></i>
                  </button>
                </td>
              </tr>
              <tr *ngIf="invoices.length === 0" class="empty-row">
                <td colspan="7">
                  <i class="bi bi-receipt"></i>
                  {{ 'VEHICLE_ORDERS.DETAIL.NO_INVOICES' | translate }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- History -->
    <div class="detail-card">
      <div class="detail-card-header" (click)="historyCollapsed = !historyCollapsed">
        <i class="bi bi-clock-history"></i>
        <h6>{{ 'VEHICLE_ORDERS.HISTORY.TITLE' | translate }}</h6>
        <i class="bi bi-chevron-down toggle-icon ms-auto" [class.rotated]="historyCollapsed"></i>
      </div>
      <div [hidden]="historyCollapsed">
        <div *ngIf="historyLoading" class="detail-loading" style="padding: 30px 20px;">
          <div class="spinner-border spinner-border-sm" role="status"></div>
        </div>
        <div *ngIf="!historyLoading && historyItems.length === 0" class="history-empty">
          <i class="bi bi-clock"></i>
          {{ 'VEHICLE_ORDERS.HISTORY.NO_HISTORY' | translate }}
        </div>
        <div *ngIf="!historyLoading && historyItems.length > 0" class="history-timeline">
          <div class="history-item" *ngFor="let h of historyItems">
            <div class="history-icon" [style.background]="getActionColor(h.action) + '18'" [style.color]="getActionColor(h.action)">
              <i class="bi" [ngClass]="getActionIcon(h.action)"></i>
            </div>
            <div class="history-content">
              <div class="history-action">{{ 'VEHICLE_ORDERS.HISTORY.ACTIONS.' + h.action | translate }}</div>
              <div *ngIf="h.details" class="history-details">{{ h.details }}</div>
              <div class="history-meta">
                <span *ngIf="getPerformerName(h)" class="history-user">
                  <i class="bi bi-person-fill"></i>{{ getPerformerName(h) }}
                </span>
                <span class="history-time">
                  <i class="bi bi-clock"></i>{{ h.createdAtUtc | date:'yyyy-MM-dd hh:mm a' }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </ng-container>

  </ng-container>

  <!-- Workflow child route outlet (always available for router) -->
  <router-outlet></router-outlet>

</div>
